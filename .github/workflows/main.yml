name: Testes QA-Solar - CI

on:
  pull_request:
    branches:
      - main
      - main-workflow
  workflow_dispatch:

jobs:
  filter:
    name: Filtrar arquivos alterados
    runs-on: ubuntu-latest
    outputs:
      docs: ${{ steps.filter.outputs.docs }}
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      cypress: ${{ steps.filter.outputs.cypress }}
      playwright: ${{ steps.filter.outputs.playwright }}
      robot: ${{ steps.filter.outputs.robot }}
      selenium: ${{ steps.filter.outputs.selenium }}
      k6: ${{ steps.filter.outputs.k6 }}
    steps:
      - name: Filtrar arquivos alterados
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            docs:
              - 'docs/**'
            backend:
              - 'apps/backend/**'
            frontend:
              - 'apps/frontend/**'
            cypress:
              - 'tests/cypress/**'
            playwright:
              - 'tests/playwright/**'
            robot:
              - 'tests/robot/**'
            selenium:
              - 'tests/selenium/**'
            k6:
              - 'tests/k6/**'

  backend-tests:
    uses: ./.github/workflows/backend.yml

  cypress-tests:
    needs: [backend-tests]
    uses: ./.github/workflows/cypress.yml

  playwright-tests:
    needs: [backend-tests]
    uses: ./.github/workflows/playwright.yml

  robot-framework-tests:
    needs: [backend-tests]
    uses: ./.github/workflows/robot.yml

  selenium-tests:
    needs: [backend-tests]
    uses: ./.github/workflows/selenium.yml

  docker-deploy:
    if: github.base_ref == 'main'
    needs:
      [cypress-tests, playwright-tests, robot-framework-tests, selenium-tests]
    uses: ./.github/workflows/docker-deploy.yml
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  docs-deploy:
    if: github.base_ref == 'main' && needs.filter.outputs.docs == 'true'
    needs:
      [
        filter,
        cypress-tests,
        playwright-tests,
        robot-framework-tests,
        selenium-tests,
      ]
    uses: ./.github/workflows/docs-deploy.yml
    permissions:
      contents: write
